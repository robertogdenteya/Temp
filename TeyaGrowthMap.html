<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Teya Growth Map — Stylized Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Heatmap -->
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <!-- Papa Parse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --blue:#008BB9; --lime:#E0E722; }
    html, body { height:100%; margin:0; background:#fff; }
    body { font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    #map { position:absolute; inset:0; }
    .panel{
      position:absolute; left:12px; top:12px; z-index:500;
      background:#fff; border:1px solid #ddd; border-radius:10px;
      padding:10px 12px; box-shadow:0 6px 20px rgba(0,0,0,.08);
      display:flex; flex-direction:column; gap:10px; min-width:380px;
    }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .count { margin-left:auto; font-variant-numeric:tabular-nums; font-weight:600; }
    .slider { width:100%; display:grid; grid-template-columns:1fr 80px; gap:8px; align-items:center; }
    input[type=range]{ width:100%; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    button, select{ padding:6px 10px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .note{ color:#666; font-size:12px; }
    .tight { gap:6px; }
    .num { width:4.5rem; }
    /* Faint label approach */
    .labels-fade { opacity: .35; filter: saturate(0.2); }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div class="row">
      <strong>Teya growth by month</strong>
      <span class="count" id="totalCount">0</span>
    </div>

    <div class="row tight">
      <button id="playBtn">▶ Play</button>
      <button id="fitBtn">Fit</button>

      <!-- Heat palette -->
      <label>Palette
        <select id="paletteSel" title="Heatmap palette">
          <option value="teyaSoft" selected>Teya Soft</option>
          <option value="teya">Teya (Blue → Lime)</option>
          <option value="teyaBlue">Teya Blue only</option>
        </select>
      </label>

      <!-- Heat tuning -->
      <label>Radius <input id="radiusInp" class="num" type="number" min="6" max="40" step="1" value="18"></label>
      <label>Blur <input id="blurInp" class="num" type="number" min="4" max="40" step="1" value="15"></label>
    </div>

    <!-- Basemap style switcher -->
    <div class="row tight">
      <label>Basemap
        <select id="basemapSel" title="Basemap style">
          <option value="light-nolabels" selected>Light (no labels)</option>
          <option value="light-labels">Light (faint labels)</option>
          <option value="dark-nolabels">Dark (no labels)</option>
          <option value="dark-labels">Dark (faint labels)</option>
        </select>
      </label>
    </div>

    <div class="slider">
      <input id="monthSlider" type="range" min="0" max="0" step="1" value="0">
      <div>
        <div id="monthLabel" class="mono">—</div>
        <div id="rangeLabel" class="note">—</div>
      </div>
    </div>

    <div class="note">
      CSV: <span class="mono">merchantmapoct25-dates.csv</span>
      <span id="status" class="count">Loading…</span>
    </div>
    <div class="note" id="debugNote"></div>
  </div>

<script>
/* === CONFIG (uses your exact headers) === */
const CSV_PATH = "merchantmapoct25-dates.csv"; // same folder as this HTML
const COLS = {
  name: "MERCHANT_NAME",
  activity: "BUSINESS_ACTIVITY",
  date: "START_OF_MERCHANT_REPORTING",
  lat: "Latitude",
  lon: "Longitude"
};

/* === Brand gradients for Leaflet.heat (0..1 keys) === */
const TEYA_BLUE = '#008BB9';
const TEYA_LIME = '#E0E722';

const GRADIENTS = {
  teya: {
    0.00: 'rgba(0,139,185,0)',
    0.20: 'rgba(0,139,185,0.25)',
    0.40: 'rgba(0,139,185,0.55)',
    0.65: TEYA_BLUE,
    0.85: '#c8d40f',
    1.00: TEYA_LIME
  },
  teyaBlue: {
    0.00: 'rgba(0,139,185,0)',
    0.25: 'rgba(0,139,185,0.35)',
    0.50: 'rgba(0,139,185,0.65)',
    0.75: TEYA_BLUE,
    1.00: '#005f7e'
  },
  teyaSoft: {
    0.00: 'rgba(0,139,185,0)',
    0.30: 'rgba(0,139,185,0.20)',
    0.55: 'rgba(0,139,185,0.45)',
    0.78: 'rgba(224,231,34,0.70)',
    1.00: TEYA_LIME
  }
};

/* === MAP setup with stylized Carto basemaps (no API key) === */
const map = L.map('map', { preferCanvas:true }).setView([51.5, -0.1], 5);

/* Base raster tiles */
const tiles = {
  'light-nolabels': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '&copy; OSM & CARTO' }),
  'light-labels':   L.layerGroup([
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { maxZoom: 19 }),
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { maxZoom: 19, opacity: 0.35, className: 'labels-fade' })
                      ]),
  'dark-nolabels':  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '&copy; OSM & CARTO' }),
  'dark-labels':    L.layerGroup([
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { maxZoom: 19 }),
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { maxZoom: 19, opacity: 0.35, className: 'labels-fade' })
                      ])
};

let currentBase = tiles['light-nolabels'].addTo(map);

/* UI refs */
const statusEl = document.getElementById('status');
const debugEl  = document.getElementById('debugNote');
const totalEl  = document.getElementById('totalCount');
const slider   = document.getElementById('monthSlider');
const monthLab = document.getElementById('monthLabel');
const rangeLab = document.getElementById('rangeLabel');
const playBtn  = document.getElementById('playBtn');
const fitBtn   = document.getElementById('fitBtn');
const paletteSel = document.getElementById('paletteSel');
const radiusInp = document.getElementById('radiusInp');
const blurInp   = document.getElementById('blurInp');
const basemapSel= document.getElementById('basemapSel');

let points = [];     // [{lat,lon,date,ym,name,activity}]
let months = [];     // ['YYYY-MM', ...]
let monthEnd = {};   // map ym -> cumulative end index
let heatLayer = null;
let playTimer = null;

/* Helpers */
const fmtYM = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
function parseUK(s){
  const m = String(s||"").match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1]);
  const d = new Date(s);
  return isNaN(d) ? null : d;
}
function updateLabels(idx){
  const ym = months[idx] || "—";
  monthLab.textContent = ym;
  if (months.length) rangeLab.textContent = `${months[0]} → ${months[months.length-1]}`;
}

/* Heat layer */
function ensureHeatLayer() {
  const radius = Math.max(6, Math.min(40, parseInt(radiusInp.value,10) || 18));
  const blur   = Math.max(4, Math.min(40, parseInt(blurInp.value,10) || 15));
  const gradient = GRADIENTS[paletteSel.value] || GRADIENTS.teyaSoft;

  if (!heatLayer) {
    heatLayer = L.heatLayer([], { radius, blur, maxZoom: 12, max: 1.0, gradient }).addTo(map);
  } else {
    heatLayer.setOptions({ radius, blur, gradient });
    heatLayer.setLatLngs(heatLayer._latlngs || []);
  }
}

/* Draw cumulative */
function setView(idx){
  const ym = months[idx], end = monthEnd[ym] ?? -1;
  if (end < 0){
    totalEl.textContent = "0";
    if (heatLayer) heatLayer.setLatLngs([]);
    return;
  }
  const cum = points.slice(0, end+1);
  totalEl.textContent = cum.length.toLocaleString();

  const last = end;
  const heatPts = cum.map((p,i)=>[p.lat, p.lon, 0.6 + 0.4*(i/Math.max(1,last))]); // 0.6..1
  heatLayer.setLatLngs(heatPts);
}

/* Fit */
function fit(){
  if (!points.length) return;
  const lats = points.map(p=>p.lat), lons = points.map(p=>p.lon);
  map.fitBounds([[Math.min(...lats), Math.min(...lons)], [Math.max(...lats), Math.max(...lons)]], { padding:[30,30] });
}

/* UI events */
slider.addEventListener('input', ()=>{ const i=+slider.value; updateLabels(i); setView(i); });
fitBtn.addEventListener('click', fit);
paletteSel.addEventListener('change', ensureHeatLayer);
radiusInp.addEventListener('change', ensureHeatLayer);
blurInp.addEventListener('change', ensureHeatLayer);
playBtn.addEventListener('click', ()=>{
  if (playTimer){ clearInterval(playTimer); playTimer=null; playBtn.textContent="▶ Play"; return; }
  playBtn.textContent="⏸ Pause";
  playTimer = setInterval(()=>{
    let i=+slider.value; if (i>=+slider.max){ clearInterval(playTimer); playTimer=null; playBtn.textContent="▶ Play"; return; }
    slider.value=i+1; slider.dispatchEvent(new Event('input'));
  }, 300);
});
basemapSel.addEventListener('change', ()=>{
  map.removeLayer(currentBase);
  currentBase = tiles[basemapSel.value];
  currentBase.addTo(map);
});

/* Load CSV */
(async function load(){
  try {
    statusEl.textContent = "Downloading CSV…";
    const res = await fetch(CSV_PATH + "?t=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();

    statusEl.textContent = "Parsing CSV…";
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true, delimitersToGuess: [",", ";", "\t", "|"] });

    const headers = parsed.meta?.fields || (parsed.data[0] ? Object.keys(parsed.data[0]) : []);
    const required = [COLS.lon, COLS.lat, COLS.date];
    const missing = required.filter(h => !headers.includes(h));
    debugEl.innerHTML = "Headers: " + headers.map(h=>`<code>${h}</code>`).join(", ") +
      (missing.length ? ` <span class="note">| Missing expected: ${missing.join(", ")}</span>` : "");
    if (missing.length){ statusEl.textContent = "Expected columns not found in CSV."; return; }

    const raw = [];
    for (const row of parsed.data){
      const lat = parseFloat(String(row[COLS.lat]).replace(",", "."));
      const lon = parseFloat(String(row[COLS.lon]).replace(",", "."));
      if (!isFinite(lat) || !isFinite(lon)) continue;
      const d = parseUK(row[COLS.date]); if (!d) continue;
      raw.push({ lat, lon, date:d, ym:fmtYM(d), name:row[COLS.name]||"", activity:row[COLS.activity]||"" });
    }
    if (!raw.length){ statusEl.textContent = "No valid rows with coords + date."; return; }

    raw.sort((a,b)=>a.date-b.date);
    points = raw;

    // Month index
    const start = new Date(points[0].date.getFullYear(), points[0].date.getMonth(), 1);
    const end   = new Date();
    months = [];
    const cur = new Date(start);
    while (cur <= end){ months.push(fmtYM(cur)); cur.setMonth(cur.getMonth()+1); }
    let j=0; monthEnd={};
    for (const ym of months){ while (j<points.length && points[j].ym <= ym) j++; monthEnd[ym]=j-1; }

    // Init
    slider.min = 0; slider.max = Math.max(0, months.length-1); slider.value = slider.max;
    updateLabels(+slider.value);
    ensureHeatLayer();
    setView(+slider.value);
    fit();

    statusEl.textContent = `Loaded ${points.length.toLocaleString()} merchants across ${months.length} months`;
  } catch (e){
    statusEl.textContent = "Error: " + (e.message || e);
  }
})();
</script>
</body>
</html>
