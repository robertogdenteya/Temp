<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Teya Growth Map — Professional Heatmap</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root { --blue:#008BB9; --lime:#E0E722; --ink:#111827; }
  html, body { height:100%; margin:0; background:#fff; }
  body { font:13px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink); }
  #map { position:absolute; inset:0; }

  /* Compact toolbar */
  .hud {
    position:absolute; left:12px; top:12px; z-index:500;
    display:flex; gap:6px; flex-direction:column;
  }
  .toolbar {
    background: rgba(255,255,255,0.75);
    border:1px solid rgba(17,24,39,0.08);
    backdrop-filter: blur(6px);
    border-radius:10px;
    padding:6px 8px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    display:flex; align-items:center; gap:8px;
  }
  .btn, select, input[type=number] {
    appearance:none; -webkit-appearance:none; font:inherit;
    padding:4px 8px; border:1px solid #d1d5db; border-radius:8px; background:#fff;
    line-height:1.1; height:26px; cursor:pointer;
  }
  .btn { padding:4px 10px; }
  .btn.primary { background:var(--blue); color:#fff; border-color:var(--blue); }
  .btn:disabled { opacity:.6; cursor:not-allowed; }
  .num { width:3.5rem; }

  /* Micro slider */
  .range-wrap { display:flex; align-items:center; gap:8px; min-width:220px; }
  .range {
    -webkit-appearance:none; appearance:none; width:100%; height:4px; border-radius:999px; background:#e5e7eb; outline:none;
  }
  .range::-webkit-slider-thumb {
    -webkit-appearance:none; appearance:none; width:14px; height:14px; border-radius:50%;
    background:var(--blue); border:2px solid #fff; box-shadow:0 1px 4px rgba(0,0,0,.25); cursor:pointer; margin-top:-5px;
  }
  .range::-moz-range-thumb {
    width:14px; height:14px; border-radius:50%;
    background:var(--blue); border:2px solid #fff; box-shadow:0 1px 4px rgba(0,0,0,.25); cursor:pointer;
  }

  /* Bottom-left tiny status */
  .chip {
    position:absolute; left:12px; bottom:12px; z-index:500;
    background:rgba(255,255,255,0.75);
    border:1px solid rgba(17,24,39,0.08);
    border-radius:999px; padding:4px 8px;
    font-variant-numeric: tabular-nums; box-shadow:0 6px 18px rgba(0,0,0,.06);
  }
  .chip code { background:transparent; padding:0; }

  /* On-map month label (geo-anchored) */
  .month-map-label {
    font-weight:800; letter-spacing:0.01em;
    font-size: clamp(18px, 3.2vw, 36px);
    color:#0c1f27;
    background:rgba(255,255,255,0.72);
    border:1px solid rgba(17,24,39,0.08);
    border-radius:12px;
    padding:6px 10px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    backdrop-filter: blur(6px);
    user-select:none; pointer-events:none;
    white-space:nowrap;
  }
</style>
</head>
<body>
  <!-- Compact HUD -->
  <div class="hud">
    <div class="toolbar">
      <button id="playBtn" class="btn primary" title="Play/Pause">▶</button>
      <div class="range-wrap">
        <input id="monthSlider" class="range" type="range" min="0" max="0" step="1" value="0" />
      </div>
      <select id="paletteSel" title="Palette">
        <option value="teyaSoft" selected>Soft</option>
        <option value="teya">Blue→Lime</option>
        <option value="teyaBlue">Blue</option>
      </select>
      <label title="Heat radius">R
        <input id="radiusInp" class="num" type="number" min="6" max="40" step="1" value="18">
      </label>
      <label title="Heat blur">B
        <input id="blurInp" class="num" type="number" min="4" max="40" step="1" value="15">
      </label>
      <button id="fitBtn" class="btn" title="Fit to data">Fit</button>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Bottom-left tiny status -->
  <div class="chip">
    <span id="totalCount">0</span> merchants • CSV <code>merchantmapoct25-dates.csv</code>
  </div>

<script>
/* CSV config */
const CSV_PATH = "merchantmapoct25-dates.csv";
const COLS = {
  name: "MERCHANT_NAME",
  activity: "BUSINESS_ACTIVITY",
  date: "START_OF_MERCHANT_REPORTING",
  lat: "Latitude",
  lon: "Longitude"
};

/* Brand gradients */
const TEYA_BLUE = '#008BB9';
const TEYA_LIME = '#E0E722';
const GRADIENTS = {
  teya: {
    0.00:'rgba(0,139,185,0)', 0.20:'rgba(0,139,185,0.25)', 0.40:'rgba(0,139,185,0.55)',
    0.65:TEYA_BLUE, 0.85:'#c8d40f', 1.00:TEYA_LIME
  },
  teyaBlue: {
    0.00:'rgba(0,139,185,0)', 0.25:'rgba(0,139,185,0.35)', 0.50:'rgba(0,139,185,0.65)',
    0.75:TEYA_BLUE, 1.00:'#005f7e'
  },
  teyaSoft: {
    0.00:'rgba(0,139,185,0)', 0.30:'rgba(0,139,185,0.18)', 0.55:'rgba(0,139,185,0.38)',
    0.78:'rgba(224,231,34,0.58)', 1.00:TEYA_LIME
  }
};

/* Map */
const map = L.map('map', { preferCanvas:true }).setView([55.5, -3], 5);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
  maxZoom: 19, attribution: '&copy; OSM & CARTO'
}).addTo(map);

/* On-map month/year label as a geo-anchored DivIcon */
const OVERLAY_POS = [60.8, -11]; // between Iceland & UK; tweak if needed
let monthMarker = L.marker(OVERLAY_POS, {
  interactive:false,
  zIndexOffset: 10000,
  icon: L.divIcon({
    className: '',
    html: '<div class="month-map-label">—</div>',
    iconSize: [0,0]
  })
}).addTo(map);
const setMonthText = (txt) => {
  const el = monthMarker.getElement();
  if (el) el.querySelector('.month-map-label').textContent = txt || '—';
};

/* UI refs */
const playBtn   = document.getElementById('playBtn');
const fitBtn    = document.getElementById('fitBtn');
const slider    = document.getElementById('monthSlider');
const paletteSel= document.getElementById('paletteSel');
const radiusInp = document.getElementById('radiusInp');
const blurInp   = document.getElementById('blurInp');
const totalEl   = document.getElementById('totalCount');

/* State */
let points=[], months=[], monthEnd={};
let heatLayer=null, playTimer=null;

/* Helpers */
const fmtYM = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
function humanYM(ym){ if(!ym) return "—"; const [y,m]=ym.split('-'); const d=new Date(+y, +m-1, 1); return d.toLocaleString(undefined,{ month:'long', year:'numeric' }); }
function parseUK(s){
  const m = String(s||"").match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1]);
  const d = new Date(s); return isNaN(d) ? null : d;
}
function ensureHeatLayer() {
  const radius = Math.max(6, Math.min(40, parseInt(radiusInp.value,10) || 18));
  const blur   = Math.max(4, Math.min(40, parseInt(blurInp.value,10) || 15));
  const gradient = GRADIENTS[paletteSel.value] || GRADIENTS.teyaSoft;
  if (!heatLayer) {
    heatLayer = L.heatLayer([], { radius, blur, maxZoom:12, max:1.0, gradient }).addTo(map);
  } else {
    heatLayer.setOptions({ radius, blur, gradient });
    heatLayer.setLatLngs(heatLayer._latlngs || []);
  }
}
function setView(idx){
  const ym = months[idx]; const end = monthEnd[ym] ?? -1;
  setMonthText(humanYM(ym));
  if (end < 0){ totalEl.textContent="0"; if (heatLayer) heatLayer.setLatLngs([]); return; }
  const cum = points.slice(0, end+1);
  totalEl.textContent = cum.length.toLocaleString();
  const last = end;
  const heatPts = cum.map((p,i)=>[p.lat, p.lon, 0.6 + 0.4*(i/Math.max(1,last))]); // 0.6..1.0
  heatLayer.setLatLngs(heatPts);
}
function fit(){
  if (!points.length) return;
  const lats=points.map(p=>p.lat), lons=points.map(p=>p.lon);
  map.fitBounds([[Math.min(...lats), Math.min(...lons)], [Math.max(...lats), Math.max(...lons)]], { padding:[24,24] });
}

/* UI events */
slider.addEventListener('input', ()=> setView(+slider.value));
paletteSel.addEventListener('change', ensureHeatLayer);
radiusInp.addEventListener('change', ensureHeatLayer);
blurInp.addEventListener('change', ensureHeatLayer);
fitBtn.addEventListener('click', fit);
playBtn.addEventListener('click', ()=>{
  if (playTimer){ clearInterval(playTimer); playTimer=null; playBtn.textContent="▶"; return; }
  playBtn.textContent="⏸";
  playTimer = setInterval(()=>{
    let i=+slider.value;
    if (i>=+slider.max){ clearInterval(playTimer); playTimer=null; playBtn.textContent="▶"; return; }
    slider.value=i+1; slider.dispatchEvent(new Event('input'));
  }, 150); // twice as fast as 300ms
});

/* Load CSV */
(async function(){
  try {
    const res = await fetch(CSV_PATH + "?t=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    const parsed = Papa.parse(text, { header:true, skipEmptyLines:true, delimitersToGuess:[",",";","\t","|"] });

    const headers = parsed.meta?.fields || (parsed.data[0] ? Object.keys(parsed.data[0]) : []);
    const required = [COLS.lon, COLS.lat, COLS.date];
    if (required.some(h => !headers.includes(h))) { alert("Expected columns not found in CSV."); return; }

    const rows=[];
    for (const row of parsed.data) {
      const lat = parseFloat(String(row[COLS.lat]).replace(",", "."));
      const lon = parseFloat(String(row[COLS.lon]).replace(",", "."));
      if (!isFinite(lat) || !isFinite(lon)) continue;
      const d = parseUK(row[COLS.date]); if (!d) continue;
      rows.push({ lat, lon, date:d, ym:fmtYM(d) });
    }
    if (!rows.length) { alert("No valid rows with coordinates + date."); return; }

    rows.sort((a,b)=>a.date-b.date);
    points = rows;

    // Build months
    const start = new Date(points[0].date.getFullYear(), points[0].date.getMonth(), 1);
    const end   = new Date();
    months = [];
    const cur = new Date(start);
    while (cur <= end){ months.push(fmtYM(cur)); cur.setMonth(cur.getMonth()+1); }
    let j=0; monthEnd={};
    for (const ym of months){ while (j<points.length && points[j].ym <= ym) j++; monthEnd[ym]=j-1; }

    // Init
    slider.min = 0; slider.max = Math.max(0, months.length-1); slider.value = slider.max;
    ensureHeatLayer();
    setView(+slider.value);
    fit();
  } catch (e) {
    console.error(e);
    alert("Error: " + (e.message || e));
  }
})();
</script>
</body>
</html>
