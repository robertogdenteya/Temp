<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Teya Growth Map — Merchants over time</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Heatmap + Clusters -->
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Papa Parse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --blue:#008BB9; --lime:#E0E722; }
    html, body { height:100%; margin:0; }
    body { font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    #map { position:absolute; inset:0; }
    .panel {
      position:absolute; left:12px; top:12px; z-index:500;
      background:#fff; border:1px solid #ddd; border-radius:10px;
      padding:10px 12px; box-shadow:0 6px 20px rgba(0,0,0,.08);
      display:flex; flex-direction:column; gap:10px; min-width:340px;
    }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .count { margin-left:auto; font-variant-numeric:tabular-nums; font-weight:600; }
    .slider { width:100%; display:grid; grid-template-columns:1fr 72px; gap:8px; align-items:center; }
    input[type=range]{ width:100%; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    button, select{ padding:6px 10px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .note{ color:#666; font-size:12px; }
    .warn{ color:#b00020; font-weight:600; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div class="row">
      <strong>Teya growth by month</strong>
      <span class="count" id="totalCount">0</span>
    </div>

    <div class="row">
      <button id="playBtn">▶ Play</button>
      <select id="modeSel">
        <option value="heat" selected>Heatmap (fast)</option>
        <option value="cluster">Marker clusters</option>
      </select>
      <button id="fitBtn">Fit</button>
    </div>

    <div class="slider">
      <input id="monthSlider" type="range" min="0" max="0" step="1" value="0">
      <div>
        <div id="monthLabel" class="mono">—</div>
        <div id="rangeLabel" class="note">—</div>
      </div>
    </div>

    <div class="note">
      CSV: <span class="mono" id="csvName">merchantmapoct25-dates.csv</span>
      <span id="status" class="count">Loading…</span>
    </div>
    <div class="note" id="debugNote"></div>
  </div>

<script>
/* === CONFIG (uses your exact headers) === */
const CSV_PATH = "merchantmapoct25-dates.csv"; // same folder as this HTML
const COLS = {
  name: "MERCHANT_NAME",
  activity: "BUSINESS_ACTIVITY",
  date: "START_OF_MERCHANT_REPORTING",
  lat: "Latitude",
  lon: "Longitude"
};

/* === MAP === */
const map = L.map('map', { preferCanvas:true }).setView([51.5, -0.1], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z
